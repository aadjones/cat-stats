import type { CharacterSheet } from '../../core/personality/types';

// Extract just the text generation logic for testing
function generateExportText(characterSheet: CharacterSheet): string {
  const { characterData, stats, petName } = characterSheet;

  return `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           CATSTATS                            â•‘
â•‘                    FELINE LEGEND CHARACTER SHEET             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

ðŸ± NAME: ${petName.toUpperCase()}
ðŸ† ARCHETYPE: ${characterData.archetype}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        CORE ATTRIBUTES                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Wisdom...................................... ${stats.wisdom.toString().padStart(3)} â•‘
â•‘ Cunning..................................... ${stats.cunning.toString().padStart(3)} â•‘
â•‘ Agility..................................... ${stats.agility.toString().padStart(3)} â•‘
â•‘ Stealth..................................... ${stats.stealth.toString().padStart(3)} â•‘
â•‘ Charisma.................................... ${stats.charisma.toString().padStart(3)} â•‘
â•‘ Resolve..................................... ${stats.resolve.toString().padStart(3)} â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš”ï¸  COMBAT MOVES:
${characterData.combatMoves
  .map(
    (ability) =>
      `â€¢ ${ability.name}\n  ${ability.stats}\n  ${ability.description}\n`
  )
  .join('')}

ðŸŒ ENVIRONMENTAL POWERS:
${characterData.environmentalPowers
  .map(
    (ability) =>
      `â€¢ ${ability.name}\n  ${ability.stats}\n  ${ability.description}\n`
  )
  .join('')}

ðŸ’¬ SOCIAL SKILLS:
${characterData.socialSkills
  .map(
    (ability) =>
      `â€¢ ${ability.name}\n  ${ability.stats}\n  ${ability.description}\n`
  )
  .join('')}

ðŸ”® PASSIVE TRAITS:
${characterData.passiveTraits
  .map(
    (ability) =>
      `â€¢ ${ability.name}\n  ${ability.stats}\n  ${ability.description}\n`
  )
  .join('')}

âš ï¸  CRITICAL VULNERABILITY:
â€¢ ${characterData.weakness.name}
  ${characterData.weakness.description}

ðŸ•’ SITUATIONAL MODIFIERS:
${characterData.timeModifiers
  .map((modifier) => `â€¢ ${modifier.name}: ${modifier.effect}\n`)
  .join('')}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    Generated by CatStats                     â•‘
â•‘                  Turn your pet into a legend!                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;
}

describe('Export Service', () => {
  const mockCharacterSheet: CharacterSheet = {
    petName: 'Whiskers',
    stats: {
      wisdom: 85,
      cunning: 72,
      agility: 90,
      stealth: 65,
      charisma: 78,
      resolve: 88,
      boldness: 70,
    },
    characterData: {
      archetype: 'The Swift Hunter',
      combatMoves: [
        {
          name: 'Lightning Pounce',
          stats: 'Agility â€¢ 95% â€¢ Instant',
          description:
            'A devastatingly fast attack that catches enemies off guard',
        },
      ],
      environmentalPowers: [
        {
          name: 'Tree Climbing',
          stats: 'Agility â€¢ 100% â€¢ 5s',
          description: 'Can scale any vertical surface effortlessly',
        },
      ],
      socialSkills: [
        {
          name: 'Purr Persuasion',
          stats: 'Charisma â€¢ 85% â€¢ +2 Influence',
          description: 'Wins over humans with irresistible purring',
        },
      ],
      passiveTraits: [
        {
          name: 'Night Vision',
          stats: 'Passive â€¢ Always Active â€¢ +50% Night Stealth',
          description: 'Sees perfectly in complete darkness',
        },
      ],
      weakness: {
        name: 'Laser Pointer Distraction',
        description:
          'Cannot resist chasing that elusive red dot, -40 to all stats when active',
      },
      timeModifiers: [
        {
          name: 'Dawn Hunter Mode',
          effect: 'Agility +15 and Stealth +10 during early morning hours',
        },
      ],
    },
    petPhoto: null,
  };

  describe('generateExportText', () => {
    test('includes pet name in uppercase', () => {
      const result = generateExportText(mockCharacterSheet);
      expect(result).toContain('ðŸ± NAME: WHISKERS');
    });

    test('includes character archetype', () => {
      const result = generateExportText(mockCharacterSheet);
      expect(result).toContain('ðŸ† ARCHETYPE: The Swift Hunter');
    });

    test('formats all stats with proper padding', () => {
      const result = generateExportText(mockCharacterSheet);

      // Check that stats are right-aligned with padding (actual format has 2 spaces)
      expect(result).toContain(
        'â•‘ Wisdom......................................  85 â•‘'
      );
      expect(result).toContain(
        'â•‘ Cunning.....................................  72 â•‘'
      );
      expect(result).toContain(
        'â•‘ Agility.....................................  90 â•‘'
      );
    });

    test('includes all combat moves with proper formatting', () => {
      const result = generateExportText(mockCharacterSheet);

      expect(result).toContain('âš”ï¸  COMBAT MOVES:');
      expect(result).toContain('â€¢ Lightning Pounce');
      expect(result).toContain('  Agility â€¢ 95% â€¢ Instant');
      expect(result).toContain(
        '  A devastatingly fast attack that catches enemies off guard'
      );
    });

    test('includes all ability sections', () => {
      const result = generateExportText(mockCharacterSheet);

      expect(result).toContain('ðŸŒ ENVIRONMENTAL POWERS:');
      expect(result).toContain('ðŸ’¬ SOCIAL SKILLS:');
      expect(result).toContain('ðŸ”® PASSIVE TRAITS:');
      expect(result).toContain('âš ï¸  CRITICAL VULNERABILITY:');
      expect(result).toContain('ðŸ•’ SITUATIONAL MODIFIERS:');
    });

    test('handles empty ability arrays gracefully', () => {
      const emptyCharacter: CharacterSheet = {
        ...mockCharacterSheet,
        characterData: {
          ...mockCharacterSheet.characterData,
          combatMoves: [],
          environmentalPowers: [],
          socialSkills: [],
          passiveTraits: [],
          timeModifiers: [],
        },
      };

      const result = generateExportText(emptyCharacter);

      // Should still contain section headers but no bullet points from abilities
      expect(result).toContain('âš”ï¸  COMBAT MOVES:');
      // Should still have bullet point from weakness section, so we can't check for complete absence
      const combatSection = result
        .split('âš”ï¸  COMBAT MOVES:')[1]
        .split('ðŸŒ ENVIRONMENTAL POWERS:')[0];
      expect(combatSection).not.toContain('â€¢ ');
    });

    test('preserves weakness information', () => {
      const result = generateExportText(mockCharacterSheet);

      expect(result).toContain('â€¢ Laser Pointer Distraction');
      expect(result).toContain(
        'Cannot resist chasing that elusive red dot, -40 to all stats when active'
      );
    });

    test('includes CatStats branding', () => {
      const result = generateExportText(mockCharacterSheet);

      expect(result).toContain('Generated by CatStats');
      expect(result).toContain('Turn your pet into a legend!');
    });
  });
});
